---
title: 'Dynamic scheduling of flexible bus services with hybrid requests and fairness: Heuristics-guided multi-agent reinforcement learning with imitation learning 学习笔记'
date: 2024-10-11
permalink: /cnposts/2024/09/blog-post-17/
tags:
  - Paper summary
  - Code-sharing
---

虽然，已经博士毕业了，并且工作的内容和运筹优化、强化学习关系不大，但是个人不愿意放弃先前所积累的知识。所以，又看起来了论文，特别是强化学习求解优化问题的相关研究。

最近，阅读了一篇发表在TRB上的灵活公交调度的论文，学到了一些新的知识。考虑到，知识需要分享，通过分享也能让自己对这一论文的认识更加巩固，所以作文以记之。

论文的信息如下：
Wu, W., Zhu, Y., & Liu, R. (2024). Dynamic scheduling of flexible bus services with hybrid requests and fairness: Heuristics-guided multi-agent reinforcement learning with imitation learning. Transportation Research Part B: Methodological, 190, 103069.

从论文题目来看，这篇文章有着以下几个关键词。从这些关键词延伸，能够窥得这篇文章的研究重点。
+ 灵活公交：车辆行驶路径规划。涉及到去接哪些乘客，也就是这篇文章的研究主题；
+ 动态调度：滚动时域框架。因为这篇文章使用了滚动时域框架，所以作者将他们的研究称作为动态调度；
+ 混合需求：即时需求+预约需求。预约需求需要提前一天给出，即时需求将在车辆行驶时随时出现；作者还把场景分为了使用预测算法与不使用预测算法两种。在使用预测算法的场景中，即时需求的OD与订单乘客数将由预测算法得到；在不使用预测算法的场景中，即时需求将从历史需求中随机采样得到，并被分派到滚动时域框架的下一个period中；
+ 公平性：即时需求的等待时间差别尽可能小。具体地说，这篇文章是采用了<b>平均绝对差</b>量化即时需求的等待时间离散程度。
+ 强化学习：强化学习算法做决策。文章将每个车辆看作为一个智能体，整体上是一个多智能体强化学习问题，以强化学习算法去决策车辆的行驶路径。
+ 模仿学习：与启发式算法结合增强强化学习算法训练性能。从局部搜索缓冲区抽样的经验批次计算模仿学习损失，这些经验被用来训练RL算法，以模仿局部搜索产生的更优解。
+ 启发式算法：指导强化学习搜索。对于强化学习经验回放区内的轨迹，采用邻域搜索算法对其搜索得到一个更好的轨迹，并将更好的轨迹也给储存起来，在强化学习算法训练的时候进行指导。

这些研究重点也是文章的主要创新点所在。接下来，将详细叙述这篇文章的细节内容。

+ **摘要**
弹性公交（Flexible bus services，FBS）作为经典的需求响应式交通方式，能够为人们提供门到门的出行体验，受欢迎程度正在逐渐提高。但是，这种交通方式同时也面临着高动态性、需求即时性等挑战。以往的研究只关注服务预约需求的FBS设计，忽略了即时出行需求这一潜在市场。并且，利用历史出行数据，能够优化FBS车队的载客状况，并提高财务可持续性。对此，这篇文章提出了一个多目标决策模型来同时优化FBS的车辆路线、时刻表、等待时间与乘客分配决策，并特别强调了针对即时出行需求的公平性问题。这篇文章提出了一个结合局部搜索、滚动时域框架、模仿学习、预测算法的多智能体强化学习框架。通过数值实验验证发现，所提出的方法相比基准方法能够在训练稳定性和求解方案的质量上有进一步的提升。
+ **研究贡献**
  + **研究对象**：研究优化车辆路线、时刻表、停靠控制和乘客分配问题。这个优化场景是先前其他研究没有考虑过的。特别是，这篇文章考虑了混合请求和未来预测需求。
  + **研究方法**：
    + 设计强化学习的状态和动作表示；
    + 设计动作空间的修剪策略，减少不可行动作空间；
    + 引入仿真学习和启发式搜索方法，引导强化学习的训练；
  + **实验对象**：设计广泛的数值实验和基于真实世界的案例，验证了模型和解决方案的效果；
+ **问题描述**
  + **服务区域建模**：FBS服务区域被建模为一个有向网络 \(\mathcal{G}(\mathcal{V}, \mathcal{E})\)，其中 \(\mathcal{V} = I \cup J\) 表示节点的集合，节点包括物理停靠站（公交站和车库）。这些节点通过网络中的路段（边 \(\mathcal{E}\)）相连。
  + **需求建模**：
    + **预约请求**：这类请求包含了乘客的上车点 \(p_n \in I\)，下车点 \(d_n\)，乘客数量 \(q_n\) 和期望的时间窗 \([t_n^s, t_n^e]\)。这些请求在服务开始前一天就被收集好，并在运营计划中预先安排。
    + **即时请求**：与预约请求不同，即时请求需要在运营当天动态地加入到最新的规划周期中，服务提供者需要调整车辆行驶计划以纳入这些新增的需求。
  + **优化目标**：
    - **系统总成本最小化**：旨在通过高效的车辆调度和时间管理减少整个系统的运营成本。
    - **即时请求等待时间最小化**：减少即时请求的等待时间，以提高乘客满意度和服务的吸引力。
- **研究假设**
  - **多周期优化**：应用多周期优化来规划FBS，覆盖整个时间范围。最后一个周期除外，公交不需要返回任何特定车库。
  - **公交出发返回**：在每个周期内，公交从车库出发并在周期结束时返回车库。
  - **多次停靠点**：每个停靠点可以在每个周期内被多辆车辆多次访问。
  - **车辆同质性**：所有车辆具有相同的容量。
  - **即时请求可拒绝**：FBS运营方有权拒绝即时请求。
+ **研究方法**
    + **滚动时域框架**
滚动时域框架被用来将动态复杂的调度问题分解为一系列相互依赖的子问题。整个规划时域被划分为多个周期 \(|G|\)，每个周期长度为 \(H\)。每个周期 \(g\) 对应的请求集 \(N_g\) 包括：预约需求与即时需求。在采用需求预测的操作中，即时请求 \(N_i\) 预计会在周期 \(g\) 内提交，并在周期 \(g\) 的规划阶段纳入考虑。在没有需求预测的操作中，这些请求需要在周期 \(g\) 之前提交。每个周期 \(g\) 被进一步划分为 \(|T|\) 个时间间隔，每个智能体（即车辆）在每个时间间隔的开始只做一次决策。
<i>**虽然这篇文章应用了滚动时域框架方法，但是感觉完全没有必要使用这一方法。因为后续还用到MDP进行建模，而且MDP的时间窗划分得更细，那么这一更为粗略的Period划分就更没有必要了。**</i>
    + 优化目标
      + 第一个优化目标是最小化每个周期 \( g \) 的总系统成本，包括运营成本和用户成本：
  \[ \min (C^f_g + C^u_g), \forall g \in G \]
  其中， \( C^f_g \)为运营成本，可通过巴士的行驶里程和等待时间来计算。具体公式为：
  \[ C^f_g = \sum_{k=1}^{|K|} \sum_{t=1}^{|T|} \left[ \delta^f \cdot DIS(i_{g,t,k}, i_{g,t+1,k}) + \delta^r \cdot a^r_{g,t,k} \right] \]
        - \( DIS(i_{g,t,k}, i_{g,t+1,k}) \) 表示周期 \( g \) 中时间间隔 \( t \) 内，巴士 \( k \) 从位置 \( i_{g,t,k} \) 行驶到 \( i_{g,t+1,k} \) 的距离。
        - \( \delta^f \) 是单位距离的成本。
        - \( \delta^r \) 是巴士等待的单位时间成本。
        - \( a^r_{g,t,k} \) 是巴士 \( k \) 在周期 \( g \) 的时间间隔 \( t \) 的等待时间。
  \( C^u_g \) 为用户成本，包括因晚到而超过最后离开时间的罚款以及拒绝请求的额外成本。其计算公式为：
  \[ C^u_g = \sum_{n \in N_g} \left[ (1 - y^n) \cdot \delta^s \cdot q_n \cdot \max(t^n_p - t^n_o, 0) + y^n \cdot \delta^n \right] \]
        - \( y^n = 0 \) 表示请求 \( n \) 被接受，\( y^n = 1 \) 表示被拒绝。
        - \( \delta^s \) 是迟到每单位时间的罚款。
        - \( \delta^n \) 是拒绝请求的罚款。
        - \( q_n \) 是请求 \( n \) 的乘客数量或请求的规模。
        - \( t^n_p \) 是请求 \( n \) 的期望到达时间，\( t^n_o \) 是实际到达时间。
      + 第二个优化目标为等待时间的公平性
        + 等待时间的计算
          + 当请求 \( n \) 被接受时 (\( y^n = 0 \))，其等待时间 \( W_n \) 是期望的服务时间 \( t^n_p \) 减去实际到达时间 \( t^n_o \)。
          - 如果请求 \( n \) 被拒绝 (\( y^n = 1 \))，等待时间被计算为从实际到达时间 \( t^n_o \) 到请求被拒绝的时间 \( t^n_b \)，如果 \( t^n_b \) 大于 \( t^n_o \)，则取它们之间的差值，否则为零。
        - 公平性指标的定义： \( \xi_g \) 用于衡量周期 \( g \) 内所有请求的等待时间差异：
          \[ \xi_g = \frac{\sum_{n \in N_g} |W_n - \overline{W}_g|}{|N_g|} \]
          - \( \overline{W}_g \) 是周期 \( g \) 内所有请求等待时间的平均值。
          - \( |W_n - \overline{W}_g| \) 表示每个请求的等待时间与平均等待时间的绝对差值。
        - 优化目标：最小化 \( \xi_g \)，以减少等待时间的差异，从而提高服务的公平性：
  \[ \min \xi_g = \frac{\sum_{n \in N_g} |W_n - \overline{W}_g|}{|N_g|}, \forall g \in G \]
    + 优化约束
      + 车辆容量约束：\( z_{g,t,k} \leq Z \)  表示在任何给定的时间 \( t \)，在任何周期 \( g \)，任何巴士 \( k \) 上的乘客数 \( z_{g,t,k} \) 不得超过其最大容量 \( Z \)。
      + 运动约束：\( \sum_{g=1}^{|G|} \left[ \sum_{t=1}^{|T|} \frac{DIS(i_{g,t,k}, i_{g,t+1,k})}{vel} + \sum_{t=1}^{|T|} a^r_{g,t,k} \right] \leq |G| \cdot H \) 确保每辆公交 \( k \) 在整个规划时间 \( |G| \cdot H \) 内完成对所有请求的服务并返回车库。
      + 延迟系数约束：\( t^n_d + \frac{DIS(p^n, h^n)}{vel} \leq \alpha \cdot t^n_p \)  确保FBS的时间效率，使得从乘客的上车点 \( p^n \) 到下车点 \( h^n \) 的实际旅行时间加上乘客的等待时间 \( t^n_d \) 不会超过其期望时间 \( t^n_p \) 的 \( \alpha \) 倍。
  
    + 强化学习多目标优化（两个目标放在一起，就叫多目标）
    + 训练框架
        + 训练算法
        + epsilon-greedy改进
        + 邻域搜索
        + 损失函数
    + 预测算法
+ 数值实验


+ 对我的知识补充点