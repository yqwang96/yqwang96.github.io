---
title: '《Optimal matching for coexisting ride-hailing and ridesharing services considering pricing fairness and user choices》学习整理'
date: 2023-11-27
permalink: /cnposts/2023/11/blog-post-6/
tags:
  - 论文精读
  - 网约出行
  - 运筹优化
---


## 0. 摘要
按需移动（MoD）服务有望根本改变城市交通的模式。通常情况下，一个MoD平台会提供叫车和拼车两种服务，这在运营一个大规模实时MoD系统时带来了额外的挑战。以往的研究通常假定乘客完全遵守平台关于定价和车辆分配的决策，但实际上乘客可能会根据费用和出行体验选择不同的出行方式，这可能与从系统角度分析出的结果产生冲突。本研究考虑到价格公平性和乘客的出行方式选择，提出了一个新的框架，用于在提供叫车和拼车服务的MoD平台上优化车辆与乘客的匹配。定义了六个原则来确保共乘价格的公平性，并针对同时存在的叫车和拼车服务制定了高效的优化问题。通过在数值实验中，我们使用纽约市的出租车数据来评估我们方法的有效性，并与当前最先进的方法进行了比较。实验结果表明，我们的优化策略能够显著提高服务比率和利润，而不牺牲服务质量。

## 1. 研究背景
目前，按需出行（MoD）在世界各个城市都成为了人们的一种主要出行方式。特别地，拼车能够以低的成本出行，但是这也会导致他们的体验下降。因此，引发了乘客是否会接受拼车的行程和费用（实际上就是乘客的出行偏好）的讨论。目前一些研究发现联合优化定价和匹配是更有前景的做法，而也有一些研究考虑了定价方案的公平性，从基于路段或基于绕路的定价考虑共享行程的距离和绕路，但是他们没有考虑拼车过程中的多种特征。这篇文章中的公平性是指**绕路率更大或与更多乘客共享行程的乘客应该获得更大的折扣**。

基于此，本文关注于一个同时提供快车与拼车服务的平台，考虑公平的定价方案和乘客的出行选择，研究车辆与乘客的匹配问题。

### 1.1 研究贡献
文中写到的本文的研究贡献如下：
+ 设计了一个 MoD 框架，使车辆与乘客的匹配优化同时考虑到在共存的网约车和拼车服务中的定价公平性。
+ 总结了公平定价方法应满足的六个原则，并提出了一种具备所有期望属性的公平意识型动态拼车定价方法。
+ 构建了一个基于公平价格的车辆-乘客匹配问题，该问题考虑到了乘客的出行方式选择决策，并以线性分配问题的形式高效求解。

## 2. 研究方法

### 2.1 网约系统运行流程
在该研究中，网约出行系统的新乘客提交他们的出行请求，指定出行起点、出行终点以及最晚的接送时间。平台检查乘客的等待时间是否超出了他们的最大等待时间限制，同时处理之前未匹配的出行请求。除了因长时间等待而取消出行请求的乘客外，其他乘客将被匹配。没有匹配的乘客将继续等待下一时间窗的匹配。对于成功匹配的乘客，平台将生成一个服务菜单，提供拼车出行的折扣和绕行时间，以及快车出行和拼车出行的行程费用和预期等待时间。在收到服务菜单后，乘客将根据他们的需求选择服务。如果乘客选择快车服务，则行程报价立刻生效；如果乘客选择拼车服务，则假设平台会在确认报价前进行公平性检查。

![Flowchart showing the interactions among travellers, vehicles, and the MoD platform](https://github.com/yqwang96/yqwang96.github.io/blob/master/images/Blog6FlowChart.jpg?raw=true)

此外，如果乘客对任何一种行程报价不满意，乘客会主动拒绝报价，并退出系统。

### 2.2 不同类型的乘客
假设乘客对成本和服务质量敏感，并且具有不同的共享意愿，这些差异反映在他们的效用系数上。当平台提供明确的服务菜单后，乘客会选择他们效用最大化的出行模式。乘客$p$的效用可通过下式进行量化。

$$
u_p^h = \beta_p^h - \beta_p^t w_p^h - \beta_p^f f_p^h
$$

$$
u_p^s = \beta_p^s - \beta_p^t (w_p^s+\delta_p) - \beta_p^f f_p^s
$$

$$
u_p^o = \beta_p^o
$$

其中，$\beta_p^h, \beta_p^s, \beta_p^o$分别是反映快车、拼车和其他出行模式的固有出行质量；$\beta_p^t, \beta_p^f$为效用系数，用于将出行时间和成本转换为乘客的感知效用；$w_p^h, f_p^h$表示如果乘客使用快车出行时的预计等待时间和行程费用；而$w_p^s,\delta_p,f_p^s$分别为如果乘客使用拼车出行的等待时间、绕路时间和共享行程费用。

针对于乘客在快车、拼车和其他交通方式之间的选择行为，采用多项式Logit模型来捕捉乘客的选择。针对乘客$p$选择出行模式$m$的概率为

$$
{Pr}_p^m = \frac{\exp(u_p^m)}{\sum_{k∈{\{h,s,o\}}} \exp(u_p^k)}
$$

### 2.3 车辆

该研究关注于两种类型的车辆：快车车辆和拼车车辆。假设每辆车都按照平台的指示行驶，通过一系列接送点的路径，称为**路线**。一旦车辆到达最后目的地（即最后一名指派乘客下车时），它会在**附近停车**，以避免空驶，直到重新分配给新乘客。

### 2.4 平台

平台收集出行请求和车辆的数据，并计算 **（a）服务更多乘客** 和 **（b）最大化利润**。平台向乘客提供的服务菜单包括选定的车辆及其提供给每个潜在乘客的行程信息，如等待时间、行程费用和折扣。

+ 等待服务的出行请求会定期在派单间隔内进行批处理；
+ 平台为每个乘客-车辆配对实施插入算法，计算得到优化后的行驶路线和每个乘客的价格标签；
  + 插入方法旨在将新乘客的起点和终点插入到车辆的路线中，并贪婪的最小化总行驶距离；
+ 构建优化模型，以确定哪些快车和拼车被提供给乘客；
+ 基于平台提供的选择，乘客根据他们的自我感知效用做出决定；

## 3. 快车服务和拼车服务共存的最佳匹配

本节将快车和拼车的匹配问题建模整数线性规划问题，并另外构建一个整数规划问题将这两种服务同一起来，形成一个ILP。

### 3.1 快车行程

快车行程中每个可行的乘客-车辆匹配对斗鱼出行利润相关联，即行程费用与行程成本之间的差额。文中使用UberX的静态收费方法计算行程费用 $f_h$

$$
f_p^h = f_0 + f_t t_p + f_d d_p
$$

其中，$f_0, f_t, f_d$ 分别为基本费用、单位时间费率和单位里程费率，$t_p, d_p$ 分别为快车行程的出行时间和出行里程。基于此，文中将快车行程的最优快车-乘客匹配规划为下述ILP问题：

$$
\max_x \sum_{p} \sum_{v \in V_p} \delta (f_p^h - c_{p,v}^h)x_{p,v}-\gamma(|P|-\sum_{p} \sum_{v \in V_p} x_{p,v})
$$

$$
\sum_{v}x_{p,v} \le 1, \forall p
$$

$$
\sum_{v}x_{p,v} \le 1, \forall v \in V_p
$$

$$
x_{p,v} \in \{0, 1\}
$$

通过求解该利润最大化的线性分配问题，系统将决定乘客与车辆的最优分配。文中将其称作为HVO，但是该模型中目前没有考虑乘客选择。

### 3.2 拼车行程

(1) 公平性准则

拼车优化问题可以定义为与HVO模型相同的结果。该问题的主要挑战是为每个乘客的费用定义一个政策（policy），并当有新乘客加入和共享行程时更新该政策。文中定义了以下原则，以评估定价对乘客是否公平。

- （P1）价格上限：每位拼车服务用户的费用都应明显低于他们如果单独乘坐快车的行程费用 $f^h_p$。
- （P2）绕路公平：绕路较远的乘客应得到更大的折扣。
- （P3）拼车利益：越多的乘客共享一辆车，每个人得到的折扣就越多，因此每个人需要支付的费用就越少。
- （P4）车上乘客的理性考虑：在频繁变化的拼车环境中，随着新乘客的加入，车辆的行驶路线可能会发生改变。因此，先前指派或已经在车上的乘客的行程费用应该进行调整，确保比先前的报价低。否则，已经在车上的乘客可能不会欢迎新乘客的加入。
- （P5）车上乘客的不便成本：当车上已经有多名拼车乘客时，他们可能对新的拼车提议不那么感兴趣，因为每一位新乘客的加入都不可避免地会带来一些不便，如额外的上车和等待时间。
- （P6）平台的利润：所有乘客支付的总费用必须高于行程成本。

(2) 折扣函数

基于上述原则，设计了一个满足上述原则的折扣函数 $\Phi(\cdot)$ 。给定一个乘法折扣函数 $\Phi(\cdot)$ ，每位共乘者的拼车价格为：

$$
f^s_p = \Phi_p \cdot \hat{f}^s_p
$$

其中，$\hat{f}^s_p$ 是新乘客加入之前的价格，$\Phi_p$ 严格小于1，更新后的价格 $f^s_p$ 总是低于之前的价格 $\hat{f}^s_p$，保证车上的乘客有动力允许共享行程。初始乘客的拼车费用也通过上式计算得出，用快车出行成本 $f_p^h$ 替换 $\hat{f}^s_p$ 而得出。由于折扣通常与乘客的绕路率、共乘者数量和共享行程距离有关，引入了两个考虑这些因素的指标。

首先定义绕路指数 $\tau^d_p$，由插入新乘客造成的乘客绕路与插入后更新的行程距离之间的比率，即

$$
\tau^d_p = \frac{d_p^u - d_p^s}{d_p^u}
$$

其中，$d_p^u$ 表示插入后的更新行程距离，而 $d_p^s$ 是插入前的行程距离。由于每位乘客都有最大绕路距离限制，定义最大绕路距离为 $d_p^{max}=m·d_s$，其中 $m$ 为最大绕路比率。因此，$\tau^d_p \in [0, \frac{m}{m+1}]$。$\tau^d_p$ 越大，乘客$p$经历的绕路就越长。

此外，定义了 $\xi^r_p$ 为拼车指数，反映了乘客 $p$ 经历的拼车距离和共乘乘客数量。拼车由几个节点组成，这些节点包括共乘乘客的上车或下车地点。因此，拼车可以分成几段，这些段是两个节点之间共享行程的部分。对于每一段 $\lambda$ ，计算行程费用 $f_{\lambda}^{h}=f_t · t_{\lambda} + f_d · d_{\lambda}$。然而，如果一段路由几个共乘乘客共享，我们将该段的费用除以共乘乘客数 $k_{\lambda}$ ，称之为共享费用 $f_{\lambda}^s=f_{\lambda}^h/k_{\lambda}$。引入了一个二进制参数 $y_{p,\lambda}$，如果乘客 $p$ 经过 $\lambda$ 则为1，否则为0。定义：

$$
\xi^r_p = 1 - \frac{\sum_{\lambda} f^s_{\lambda} * y_{p,\lambda}}{\sum_{\lambda} f^h_{\lambda} * y_{p,\lambda}}
$$

作为衡量共乘者数量和共享行程距离变化的拼车指数。显然，行程中共享的部分越多，参与共乘的乘客越多，则 $\xi^r_p$ 值越大。进一步可推导出 $\xi^r_p \in [0,\frac{n-1}{n}]$，其中$n$代表车辆的乘客容量。下限 0 表示乘客$i$在整个旅程中独自一人，而上限显示最多$n$名乘客从他们共同的起点一起前往同一目的地。


最终，定义一个包含两个变量$\tau^d_p$ 和 $\xi^r_p$ 的折扣函数$\Phi$，它应该具有以下性质：

- $\Phi_p$ 的范围在 $[\Phi^{min}, \Phi^{max}]$ 之间，这里 $0 < \Phi^{min} < \Phi^{max} < 1$
- $\frac{\partial \Phi}{\partial \tau}$ 和 $\frac{\partial \Phi}{\partial \xi}$ 都小于 0
- $\frac{\partial^2 \Phi}{\partial \tau^2}$ 和 $\frac{\partial^2 \Phi}{\partial \xi^2}$ 都大于 0

值得注意的是，第一个性质与之前定义的 P1 和 P6 原则相关。第二个性质确保了 P2、P3 和 P4 原则得到满足，因为 $\tau^d_p$ 和 $\xi^r_p$ 越大，意味着有更多的绕路、更多的共乘者以及更长的共享旅程。因此 $\Phi$ 函数随着 $\tau^d_p$ 和 $\xi^r_p$的增加而单调递减。最后，二阶偏导数明显大于零表明 $\Phi$ 是一个凸函数。与线性函数相比，$\Phi$在开始时下降得更快，随着两个独立变量的增加速度减慢。这种性质确保了共乘者受到欢迎，且在车辆几乎空时从共乘中获得更多好处。相反，当车辆几乎满员时加入共乘的顾客会得到更少的折扣，这阻止了过多的旅客被分配到同一辆车，保证了P5原则得到满足。


文中构建了一个满足所有前述属性的特定折扣函数。文中选择指数函数 $y=e^{-x}$。通过用绕路 $\tau^d_p$ 和拼车 $\xi^r_p$ 指数的总和来替换$x$，得到最终的折扣率公式为：

$$
\Phi_p = \exp(-\alpha(\tau^d_p + \xi^r_p)) - b
$$

折扣系数 $\alpha$ 用于调节折扣的幅度，而基础费率$b$的设定是为了确保，如果车辆是空的，则$b > 0$，如果不是，则$b = 0$，从而保证所有共乘的乘客即使最后独自旅行也能从中获益。

(3) 拼车行程的整数线性规划

文中引入了拼车利润 $\pi_{p,\nu}$，它被定义为每当新乘客参与时所产生的边际利润，按照下列方式计算：

$$
\pi_{p,\nu} = \left( \sum_{p \in P} f^s_p - C^s_{P,\nu} \right) - \left( \sum_{p \in \hat{P}} \hat{f}^{s}_p - C^{s}_{\hat{P},\nu} \right)
$$

其中，$P$ 是包括所有被分配的乘客的集合，除了那些已经到达目的地的，而 $\hat{P}$ 代表当前乘客加入前的相同集合。$C_{\hat{P},\nu}$ 和 $C_{P,\nu}$ 分别代表为集合 $\hat{P}$ 和 $P$ 提供服务的整体行程成本。因此，拼车行程的目标函数是：

$$
\max_x \sum_p \sum_{\nu \in V_p} \pi_{P, \nu} x_{p,v} - \zeta (|P| - \sum_{p,\nu \in V_p} x_{p,\nu})
$$

将公式（15）与（7）-（9）结合起来，得到了一个新的拼车行程 ILP 公式，称为 SVO。HVO 和 SVO 可以并行处理，以确定服务菜单中的选项，这些选项随后被提交给乘客等待最终确认。由于 HVO 和 SVO 是分别处理的，我们将这两者结合起来称为个体策略。

### 3.3 整合策略

先前提出的两个整数线性规划（ILPs），HVO 和 SVO，不仅单独确定了最方便的快车和拼车行程，而且没有考虑乘客的出行方式选择。为了在提供快车和拼车服务选项时纳入乘客的出行方式选择，我们设计了一个问题，以找到每位乘客最合适的快车和拼车服务组合。

具体而言，计算了选择快车或拼车服务的概率，分别用$Pr_{s,h}^{h}$和$Pr_{s,h}^{s}$ 表示。值得注意的是，一旦确定了可能的快车和拼车服务，计算$Pr_{s,h}^{h}$和$Pr_{s,h}^{s}$可直接由式(4)计算得到。因此，为乘客 $ p $ 在提供快车 $ h $ 和拼车 $ s $ 时的预期利润为：

$$
E(\pi_{p,h,s}) = Pr^h_{s,h} \cdot \delta \cdot (f_{p,h} - c_{p,h}) + Pr^s_{s,h} \cdot \pi_{P,s}
$$

其中, $\pi_{p,s}$ 是通过公式（14）计算的。基于此，可以将整体优化问题定义为：

$$
\max_x \sum_{p} \sum_{h \in H} \sum_{s \in S} E(\pi_{p,h,s})x_{p,h,s} - \gamma(|P| - \sum_{p,h \in H, s \in S} x_{p,h,s})
$$

$$
\sum_{s} x_{p,h,s} \leq 1, \forall p
$$

$$
\sum_{p} x_{p,h,s} \leq 1, \forall h \in H
$$

$$
\sum_{p} x_{p,h,s} \leq 1, \forall s \in S
$$

$$
x_{p,h,s} \in \{0, 1\}
$$

为与上述个体策略区分开，将上述定义为整合策略。与分别解决快车和拼车问题不同，整合策略将每个潜在的快车与每个拼车车辆配对，并计算相应的快车-拼车概率对。最终，一个快车-拼车车辆对连同其他行程信息一起确定并交付给客户。

上述问题是一个三维或三指标分配问题，一般被认为是一个NP完全问题。与线性分配问题不同，该分配问题没有一个有效的解决方案保证。文中，在5.3和附录证明了该模型的特定表述能够被相对快速的解决。

## 4. 实验部分

实验中设计了两个案例研究：（a）大规模的纽约场景；（b）有限大小网络，后者用于进行灵敏度分析实验。

### 4.1 纽约案例
+ 纽约出租车数据集
  + 实验时间：晚高峰时段，两小时；
  + 数据处理：剔除异常数据-缺失记录、行程时间过短或过长；
  + 最终记录：51491条数据
  + 特征生成：最大等待时间、绕行时间、时间和费用系数、不同模式的效用系数均从截尾正态分布中提取的。<i>效用系数是基于Habib (2019) and Lavieri and Bhat(2019)得到的</i>。对于平台来说，在选择模型中，他们仅使用均值。
  + 行程可行性：实验中的行程插入后，通过下式检查行程可行性

  $$
  r_d = r_t + g_r + w + h
  $$

+ 路网数据
  + 节点路段：3671个节点和7674个有向边；
  + 车辆供给：1000辆快车和1000辆拼车；
  + 时间间隔：30秒；
  + 其他参数：定价参数、惩罚系数、折扣系数基于之前的研究得到。

+ 实验场景
为对比（a）第三节所提出的两种优化方法，和 （b）1.1节讨论的成熟策略，设计了以下四种场景的对比实验：
  + S1：分段+个体。该方法根据旅客的上车和下车节点将车辆路径分为几个部分。最终费用是所有部分费用加上基础费用之和。HVO 和 SVO 分别解决以确定最佳分配。
  + S2: mT-Share+个体。其基本原则是在出租车司机和旅客之间分配拼车利益，而不考虑司机的利润，所有好处都分配给按比例分配的拼车旅客。
  + S3：公平+个体。公平-aware的定价是基于每个用户的绕路率和拼车利益。与上述一样，HVO 和 SVO 分别解决以确定最佳网约车和拼车车辆分配，而不考虑旅客的模式选择决策。
  + S4：公平+综合。公平意识定价。与分别分配网约车和拼车车辆不同，综合策略将两种服务在一个单一的 ILP 中统一起来，补充预测旅客的出行模式选择。
  
  在拼车加入新乘客时，平台检查对于那些已经在车上的人来说，更新后的价格是否低于他们之前的价格。这激励了已上车的乘客允许其他人加入。如果这个标准得到满足，拼车的提议就被认为是有效的。如果不是，新乘客就会被潜在的共乘者拒绝，他们被动地退出系统。

### 4.2 网格网络

该较小的网络用于进行一系列敏感性分析实验，研究不同的内部（即，折扣参数，利润系数，车队规模）和外部（即，人口特征）参数选择如何影响所提出的策略。

+ 网络规模：16个节点，48条路段。
+ 车辆规模：50辆快车，50辆四座拼车
+ 需求规模：1200个乘客
+ 时间规模：1小时，30s一个间隔

## 5. 未来研究
+ 设计适应性和预测新方法，例如基于人工智能技术的针对乘客出行选择和订单取消率预测；
+ 考虑动态形式时间，将匹配、定价与实时路径规划相结合；
+ 将定价和空闲车辆的调度相结合；
+ 考虑司机参与决策过程，并考虑未来供需失衡场景。

## 6. 个人觉得未来的研究
目前的研究中虽然